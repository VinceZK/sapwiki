#+PAGEID: 1852751018
#+VERSION: 1
#+STARTUP: align
#+OPTIONS: toc:1
#+TITLE: SDD-Elimination
** General Information
*** Stakeholders and Roles
| Role                  | Name                |
|-----------------------+---------------------|
| Author(s)             | Vincent Zhang       |
| Architect             | Vincent Zhang       |
| Product Owner         | Shi Ying, Carol Pan |
| Information Developer |                     |
| Quality Responsible   | Yao Cen             |
| Developers            | Marvin Qian         |

*** References
|                     |                  |              | <30>                           |
| Document Title      | Date             | Link         | Comments                       |
|---------------------+------------------+--------------+--------------------------------|
| BPC US Elimination  | <2016-10-07 Fri> | [[http://help.sap.com/saphelp_bopacnw101/helpdata/EN/9a/cb23d5c32047fbbeb625dbcaccb42a/content.htm?frameset=/EN/c1/f9f0830a51409f90490ebe5de1584d/frameset.htm&current_toc=/en/82/f51cf12cfc48c58975b9b5e6fba9aa/plain.htm&node_id=181][online help]]  | The help doc describes the US elimination rules in BPC. |
| BCS Elimination     | <2016-10-07 Fri> | [[https://help.sap.com/saphelp_sem40bw/helpdata/en/f3/b06f3bb4983863e10000000a11402f/content.htm?frameset=/en/a3/6d723b784b1400e10000000a114084/frameset.htm&current_toc=/en/67/f7e73ac6e7ec28e10000000a114084/plain.htm&node_id=134&show_children=false][online help]]  | The help doc describes detail on how BCS run elimination and reconciliation. |
| EC-CS Elimination   | <2016-10-07 Fri> | [[http://help.sap.com/saphelp_470/helpdata/en/5c/c1bcd4445f11d189f00000e81ddfac/content.htm?frameset=/en/5c/c1bba4445f11d189f00000e81ddfac/frameset.htm&current_toc=/en/5c/c1c25f445f11d189f00000e81ddfac/plain.htm&node_id=125&show_children=false][online help]]  | The help doc describes detail on the Inter-Unit Elimination in ECCS |
| Parent Company      | <2016-10-09 Sun> | [[https://en.wikipedia.org/wiki/Parent_company][wikipedia]]    | A parent company is a company that owns enough voting stock in another firm to control management and operation by doing and influencing or electing its board of directors. The second company is deemed a subsidiary of the parent company. |
| Subsidiary          | <2016-10-09 Sun> | [[https://en.wikipedia.org/wiki/Subsidiary][wikipedia]]    | A subsidiary, subsidiary company or daughter compan is a company that is owned or controlled by another company, which is called the parent company, parent, or holding company. |
| Affiliate/Associate | <2016-10-09 Sun> | [[http://www.investopedia.com/ask/answers/06/subsidiaries.asp][investopedia]] | All three of these terms refer to the degree of ownership that a parent company holds in another company. In most cases, the terms affiliate and associate are used synonymously to describe a company whose parent only possesses a minority stake in the ownership of the company. |
| Divison             | <2016-10-09 Sun> | [[https://en.wikipedia.org/wiki/Division_(business)][wikipedia]]    | A division of a business or business division (sometimes called a business sector) is one of the parts into which a business, organization or company is divided. |
| Branch Office       | <2016-10-09 Sun> | [[http://www.investopedia.com/terms/b/branch-office.asp][investopedia]] | A location, other than the main office, where business is conducted. Most branch offices are comprised of smaller divisions of different aspects of the company such as human resources, marketing, accounting, etc. A branch office will typically have a branch manager who will report directly to, and take orders from, a management member of the main office. |

** Design
*** Context
The most basic consolidation function is the elimination of intercompany postings. If Company A and Company B are in the same group, and Company A sells something to Company B, then the corresponding bookings must be eliminated during consolidation. 

Technically, elimination does reversing on these internal transactions among entities. The difficulty is how to figure out which transactions should be eliminated. This requires a mix of intercompany and group relevant information. If under a consolidation group hierarchy, there are companies who have reciprocal transactions, then these line items should be revsered, and repost amounts to elimination accounts. 

Typical eliminations are to look at the payables and receivables of companies within one group and to eliminate them. There are also eliminations like: to look at loans and loan payments, license payments and license income, dividen payable and receivable, intercompany provisions, gains and losss on internal transfer of assets, and so on. General speaking, all cross-company postings, which most importantly impact the debit and credit balance, are relevent from eliminations.

Howerver if the companies report different values, this would result imbalanced postings during elimination. For example, if Company A reports payables to Company B 100, but B reports receivables from A of 200, the resulting elimination posting would be imbalanced by 100.

There are multiple reasons for such imbalanced postings. For example, the corresponding business process might only be processed by one company so far, or there might be an actual dispute between the two companies. Such differences are normally clarified and eliminated before the consolidation is done in the Intercompany Reconciliation. Even after successful intercompany reconciliation some, but few and minor, differences might remain. So consolidation traditionally contains means to create automatic adjustments for intercompany differences. With real-time on-the-fly consolidation, where there is no intercompany reconciliation done boeforehand, this gets even more important. 

The auto adjustment substitutes the posting from the intercompany reconciliation. As such it is a complete posting, including balancing debit and credit, including posting tax effects, document split and whatever would be part of real intercompany reconciliation positng in FI. However, we can go for a simplify version at first.

**** Example
How do elimination and auto adjustment posting look like?

We start with two companies and consider the auto adjustment for elimination of payables and receivable. So the seleciton is payables, the counter selection is receivables. The auto adjustment is posted to the company with the payable selection. 

At the start, Company A has inventory worth 1000(could be some goods to be sold), Company B has nothing. 
| Company | Partner | Account   | Amount |
|---------+---------+-----------+--------|
| A       |         | Inventory |   1000 |

Now A sells its inventory to B, however, B decides only to accept 900 as payable and inventory(maybe something got lost in transport).
| Company | Partner | Account     | Amount |
|---------+---------+-------------+--------|
| A       |         | Inventory   |   1000 |
| A       | B       | Receivables |   1000 |
| A       |         | Inventory   |  -1000 |
| B       | A       | Payables    |   -900 |
| B       |         | Inventory   |    900 |

A and B are in the same group G1, from the G1's view, the receivables of A and the corresponding payables of B should be eliminated. The eliminated lines are in italics.
| Company | Partner | Account       |  Amount |
|---------+---------+---------------+---------|
| A       |         | Inventory     |    1000 |
| A       | B       | Receivables   |    1000 |
| A       |         | Inventory     |   -1000 |
| B       | A       | Payables      |    -900 |
| B       |         | Inventory     |     900 |
| /A/     | /B/     | /Receivables/ | /-1000/ |
| /B/     | /A/     | /Payables/    |   /900/ |

Then if we see the group level report righ now(just by removing column Company and Partner, and sum all the amount up), we find 100 of inventory is lost.
| Group | Account   | Amount |
|-------+-----------+--------|
| G1    | Inventory | 900    | 

Now comes the auto adjustment. We should keep in mind that this is just a short cut for the real intercompany reconciliation. In real cases, experts would find the reason and post a document reflecting that reason. For example, increasing the receivalbes from B by 100 and creating an insurance claim from B of 100. Here, we donot know the reason of differences, we just post against IC Differences account.
| Group | Company | Partner | Account          |  Amount |
|-------+---------+---------+------------------+---------|
|       | A       |         | Inventory        |    1000 |
|       | A       | B       | Receivables      |    1000 |
|       | A       |         | Inventory        |   -1000 |
|       | B       | A       | Payables         |    -900 |
|       | B       |         | Inventory        |     900 |
|       | /A/     | /B/     | /Receivables/    | /-1000/ |
|       | /B/     | /A/     | /Payables/       |   /900/ |
| G1    | /B/     | /A/     | /IC Differences/ |   /100/ |

Let's do the final consolidated report, this now correclty shows that inventory worth 100 got lost, and that there is a correspoinding IC difference need to be cleared. 
| Group | Account        | Amount |
|-------+----------------+--------|
| G1    | Inventory      |    900 |
| G1    | IC Differences |    100 |

*** Key Requirements and Design Goals
Elimination for Real-Time Consolidation should be able to run On-The-Fly together with On-The-Fly currency translation. Performance is a key successful point under the prerequiste of those essential elimination features are fulfilled. 
**** Following Design Goals *MUST* be Met:
1. Elimination methods can be defined for each contains arbitrary number of auto adjustment steps;
2. An Elimination method generates AMDP runtime objects which can be invoked directly by all possible applications;
3. The same method also generates AMDP runables that can be excuted for reconciliation purposes;
4. Each auto adjustment step must contain a selection and a counter selection(if One-Sided is chosen, the counter selection is hided);
5. Posting strategy must be provided to control which side the adjustments should be posted;
6. Each auto adjustment step must contain differetial items definations, which can have arbitrary subitems definiations;
7. A group hierarchy must be given, and it must support time dependent;
8. Elimination result must support both reproduce and restatement due to potential changes in the group hierarchy;

**** Following Design Goals *SHOULD* be Met:
1. An elimination method should support either "One-Sided Elimination" or "Two-Sided Elimination";
2. An elimination method should support both parallelly and sequentially execution;
3. User can choose key figure/attributes for elimination comparasion and posting;
4. Differences can be splitted per transaction currency;
5. Thresholds can be defined to prevent the system from posting the elimination entry if the elimination differences are too high;
6. User can choose on which level does the threshold check applies? That is per differential line item or per method step;
7. There should be UIs to maintain consolidation group, consolidation method, and consolidation rate;
8. Document type should be defined for elimination;
9. A Fiori-based On-The-Fly report to display elimination result;

*** Major Building Blocks
#+Caption: Elimination Overall Context
[[../image/EliminationOverall.png]] 

 Elimination runs after currency translation. Because each entity can be assigned with a dedicate CT method, to converted all the data, CT methods should be run sequentially entity by entity. Local data is read from ACDOCA or ACDOCC, converted, and then saved into the global temporal table GT_ACDOCC, which has the similar structure with ACDOCC. 

The On-The-Fly CT runables and Reconciliation Runablescan read the translated data and produce On-The-Fly CT Report and Reconciliation Report directly. 

Elimination runables read the translated data and produce auto-adjustment lines, which will then inserted into GT_ACDOCC. During elimination, group hierarchy information is read, so that the system know which entities belong to the same group(or super group). Till now, GT_ACDOCC contains the eliminated data for group reporting.

On-The-Fly elimination runables converts the data in GT_ACDOCC to structured group reporting format. Besides, posting method read the data from GT_ACDOCC and then persist into ACDOCC. It Can be chosen to only post the currency transalated result or also the elimination result. 

User can also define their own reporting, as all the data needed are either in the global temporary table, or persisted in ACDOCC. 

Based on the diagram, following building blocks should be given:

**** Elimination Method                                               :Chang:
Elimination method(ELIM Method in short) can be used for both elimination and reconciliation. It shares the same technology with currency translation: AMDP and Global Temporary Table. And it can be run immediately after currency translation with a single HANA call. In other words, we can achieve on-the-fly run currency translation and elimination, which gives out a group point view of financial data.

ELIM methods are defined using an ABAP UI. It is under the unified method framework that all other consolidation methods are based on. You will see similar UIs for Currency Translation, Validation, Data Submission, and so on. The framework requires a method with multiple steps, which can either be executed sequentially, or parallely. Each step can be configured to fulfill different usages according to different method types. However, there is a share pattern for all steps. A step can be regarded as 3 ordered actions: First select data based on selections; Then calculate and convert; At last, post the result amount on differential items.

**** Group Hierarchy
Group hierarchy is the mandatory information. You must have your consolidation group hierarchy defined before running eliminations. However, group hierarchy is not the only information required by elimination, there is also ownership information(aka consolidation rate and consolidation method) attached to different viewpoints of the hierarchy. 

Also to be in mind, consolidation group defination is time-dependant. From period to period, you will see different group hierarchy and ownership information.  

~Group information is also version dependant, but it is not the version of group itself. It is actually the consolidation version that is assigned with a dedicate group hierarchy.~

**** Elimination Runables                                            :Marvin:
Elimination runables are AMDP methods that are genereted accroding the definations of an ELIM method. Elimination usually run after currency translation, that is based on the result of currency translation. The communication channel between CT and ELIM is through the global temporary table. 

The generated ELIM runables also contains the posting logic(aka the posting method of elimination). In case user wants to save the elimination auto adjustments, then settings from the assigned document type are read and applied. 

**** On-The-Fly Reporting
A Fiori-based report should be given to show the group view of the financial data after elimination(of cource, after the currency translation). The report would be a standard B/S and I/S, which can run CT and ELIM on-the-fly, and simulate accroding to different given input parameters. 

A reconciliation report is necessary to run reconciliation before running eliminations. It should also be a Fiori-based report and of course run on-the-fly with currency translation. 

#+Caption: An Example of Reconciliation Report
[[../image/ReconciliationReport.png]] 

** Detail Design
*** Elimination Method
ELIM methods are defined using an ABAP UI. It is under the unified method framework that all other consolidation methods are based on. You will see similar UIs for Currency Translation, Validation, Data Submission, and so on. The framework requires a method with multiple steps, which can either be executed sequentially or parallely. Each step can be configured to fulfill different usages according to different method types. However, there is a share pattern for all steps. A step can be regarded as 3 ordered actions: First select data based on selections; Then calculate and convert; At last, post the result amount on differential items.

**** General Settings
The settings in the general tab will effect the layout of other tabs. 

#+Caption: Elimination Method General Tab
[[../image/EliminationMethod01.png]] 

An ElIM method must be defined under a consolidation model. However it can be activated and generated runables separately. Only if fields on foundation view change do you need to re-generate ELIM method, otherwise, the runables stays consistent. 

Execution mode determines whether the generated runables allow sequential or parallel execution of steps. Parallel execution gives you better runtime performance, while sequential execution maybe somehow mandatory if you have depandency among your elimination steps.

You decide whether to use "One-Sided Elimination" or "Two-Sided Elimination" in selection mode. "Two-Sided Elimination" is much more common. It is based on two selections and is typically used for eliminations of group-internal business relationships through trade and services. By contrast, one-sided interunit elimination is a simplified form of elimination. Here, the elimination entries are based on the values listed in only one selection. You can use this simplified form of elimination for the consolidation of IU revenue and expense, in particular.

Differences Splitting allows you to analyze the reason for the elimination differences. The system distinguishes between currency-related elimination differences and other elimination differences:
+ Currency-related differences :: are incurred if a consolidation unit and its partner unit have the same transaction currency values in a business transaction, but report different group currency values because they use different local currencies and/or exchange rates.
+ Other differences :: are incurred if a consolidation unit and its partner unit use different ways of reporting business relationships in their financial data
.
Possible reasons for the different ways of reporting financial data:
+ The units post their data on different dates
+ The units use different accounting and valuation methods
+ One unit makes an error in posting
By splitting differences you can post currency-related and other differences to different accounting objects.

Check the "Split Differences Per Transaction Currency" will activate the difference splitting feature. You must also assign an exhcnage rate indicator so that the system can calulate the currency-related differences. 

Document type should be assigned to a method so that additional information like deferred taxes, selected key figures/quantity, and so on can be got during generation of ELIM runables. Document Type is a genaric attributes for all types of methods.
 
**** Method Step List
#+Caption: Elimination Method Steps Tab
[[../image/EliminationMethod02.png]] 
Step list shows an overall list of steps belong to this method. Each line shows the step ID, step description, and selections involved. If the method is "One-Sided", then only Selection1 is shown. Selection can be reuse existings or generated along with the method. Double click a line will navigate you to the step detail tab. You can also =Add= or =Delete= a step in the list view. If =Add= is clicked, it will also navigate you to the step detail tab with an empty step defination. 

You can also adjust the sequence of the steps.  The step ID has nothing to do with execution sequence. There is a hided dedicate column called "EXSEQ" to indicate what the sequence during execution. 

**** Single Step Detial
#+Caption: Elimination Method Step Detail Tab
[[../image/EliminationMethod03.png]] 

Each step has its own description. The ID of step is automatically generated and has nothing to do with the execution sequence.

For "Two-Sided Elimination", you can assign 2 selections, Selection 1 and its counter Selection 2. You use the selections to reflect the business relationships (receivables/payables and revenue/expense) between the consolidation entities within a consolidation group. The first selection contains the accounting objects; the second selection contains the offsetting accounting objects for the eliminations. If "One-Sided Elimination" is selected in the =General= tab, then the second selection is not shown.

The system differentiates elimination entries in terms of business relationships, as follows:
- The system processes a given pair of consolidation units (for example, consolidation units A and B).
- Within a pair of consolidation units, the system processes one pair of selections at a time (selection 1 and selection 2).
- The values of consolidation unit A in selection 1 (with consolidation unit B as the partner assignment) and the values of consolidation unit B in selection 2 (with consolidation unit A as the partner assignment) indicate a business relationship. The system eliminates these values and determines any existing differences.
The reverse correlation – that is, the values of consolidation unit B from selection 1 and the values of consolidation unit A from selection 2 – is also regarded as a business relationship.

If you want to restrict the values to be eliminated, you must or can select the following characteristics for each selection:
| <20>                 |                     | <50>                                               |
| Field                | Required / Optional | Purpose                                            |
|----------------------+---------------------+----------------------------------------------------|
| RACCT                | Required            | Determines the FS item or the offsetting FS item   |
| ENTITY               | Optional            | Restricts the selection of consolidation/partner units to these units when you later specify the consolidation group in an IU elimination run. If no consolidation/partner units are specified here, the system scans the business relationships for all unit pairs in the consolidation group. |
| PENTITY              | Optional            | Same as above                                      |
| Subitem              | Optional            | Restricts the values in the selection to those values that were posted with exactly this subitem(Transaction Type, producet, region, and so on). |
| DocType              | Optional            | Further restricts the selection                    |
| Other characteristics (if desired) | Optional            | Same as above                                      |

The system calculates and posts elimination differences for each business relationship between two consolidation entities (that is, a entity and a partner unit). The system posts the elimination difference to one of the two consolidation entities concerned. You can define the strategy the system uses to determine which consolidation unit the elimination difference is posted to.

You can select one of the following strategies for posting differences:
+ Consolidation enity from selection 1 or 2. In Customizing you choose whether the system posts the elimination difference to the consolidation unit:
  + from selection 1 or
  + from selection 2
+ Consolidation unit with lower or higher value. In this strategy the amount of the value of the accounting objects being eliminated determines how the elimination differences are posted. In Customizing you choose whether the system posts the elimination difference to the consolidation unit that has:
  + the lower value or
  + the higher value

You choose which key figure or which attribute for the consolidation entity is decisive for the strategy for posting differences. The specified key figure or attribute is only relevant for a posting strategy in which the elimination difference is recorded at the consolidation entity with the smaller or greater reported value. Which means the drop-down box should not be shown in case a dedicate entity for either selection 1 or 2 is chosen.
- If you specify a key figure for the consolidation entity, the system records the differences at the consolidation entity that reports the smaller or greater amount on that key figure.
- If you specify an attribute for the consolidation unit, then the relative sizes of that attribute for the consolidation unit and the partner unit determine at which consolidation unit the elimination difference is posted.

The =Check Threshold= drop-down box controls how the system compares the elimination differences with the thresholds defined in the =Thresholds= tab. 
- Per difference row or
- Per method step

You can specify differential accounting objects per method step and pair of selections. If you split the differences you can specify different accounting objects for currency-related differences and other differences. If the differential item should be broken down by subitems, you can add other characteristics and input fix values on them.

*Caution:* The differential accounting objects must be outside of the ranges you defined for the selections.

**** Thresholds
#+Caption: Elimination Method Thresholds Tab
[[../image/EliminationMethod04.png]] 

When you perform interunit (IU) eliminations, you may want to prevent the system from posting the elimination entry if the elimination differences are too high.
For this purpose, you can specify thresholds for elimination differences in Customizing:
+ per currency key and/or
+ per unit of measure

If an elimination difference exceeds the thresholds, the system merely generates a message and suggests a journal entry – the document is not posted. You can then examine the elimination differences that exceed the thresholds and post any necessary adjustments. If you regard the elimination difference as being valid and you want to post the difference, first you must deactivate the indicator for using =Check Thresholds=.

*** Examples & Deduction
**** Group Hierarchy
Following group hierarchy is used for the overall deduction.
#+Caption: Group Hierarchy
[[../image/GroupHierarchy4Deduction.png]] 

**** Customizing for Selection
Selection 1
| Field   | Expression  |
|---------+-------------|
| Account | Receivables |

Selection 2
| Field   | Expression |
|---------+------------|
| Account | Payables   |

Posting differences to the entity from Selection 1.

**** Aggreated Data from ACDOCA
The fact table is projected from ACDOCA based on company dimension. The column =Posting Level= "05" stands for the =Amount= is converted into group currency. 

| Company | Partner | Account     | TTYPE | Amount | Posting Level |
|---------+---------+-------------+-------+--------+---------------|
| B       | C       | Receivables |   100 |     60 |            05 |
| B       | C       | Receivables |   200 |     80 |            05 |
| C       | B       | Payables    |   300 |    -20 |            05 |
| C       | B       | Payables    |   100 |    -30 |            05 |

**** Elimination Result
*Case 1* 

Customzing of the Differential Items: Account and TTYPE. Account is assigned with fix values on both Debit and Credit; TTYPE is empty, which means take the value of the source lines. 
| Field          | Debit              | Credit        |
|----------------+--------------------+---------------|
| Account        | Other Expenditures | Other Revenue |
| TTYPE          |                    |               |

Auto-adjustment postings in ACDOCC, differential items are in italics.
| Company | Partner | Account              | TTYPE | Amount | Posting Level |
|---------+---------+----------------------+-------+--------+---------------|
| B       | C       | Receivables          | 100   | -60    | 20            |
| /B/     | /C/     | /Other Expenditures/ | /100/ | /60/   | /20/          |
| B       | C       | Receivables          | 200   | -80    | 20            |
| /B/     | /C/     | /Other Expenditures/ | /200/ | /80/   | /20/          |
| C       | B       | Payables             | 300   | 20     | 20            |
| /B/     | /C/     | /Other Revenue/      | /300/ | /-20/  | /20/          |
| C       | B       | Payables             | 100   | 30     | 20            |
| /B/     | /C/     | /Other Revenue/      | /100/ | /-30/  | /20/          | 

*Case 2*
Both Account and TTYPE is defined with fix values:
| Field   | Debit              | Credit        |
|---------+--------------------+---------------|
| Account | Other Expenditures | Other Revenue |
| TTYPE   | 100                | 100           |

Entries in ACDOCC:
| Company | Partner | Account              | TTYPE | Amount | Posting Level |
|---------+---------+----------------------+-------+--------+---------------|
| B       | C       | Receivables          |   100 |    -60 |            20 |
| B       | C       | Receivables          |   200 |    -80 |            20 |
| C       | B       | Payables             |   300 |     20 |            20 |
| C       | B       | Payables             |   100 |     30 |            20 |
| /B/     | /C/     | /Other Expenditures/ | /100/ |   /90/ |          /20/ |

*Case 3*
Only Account is selected, all other characteristic fields will be left with empty values. 
| Field   | Debit              | Credit        |
|---------+--------------------+---------------|
| Account | Other Expenditures | Other Revenue |

Entries in ACDOCC:
| Company | Partner | Account              | TTYPE | Amount | Posting Level |
|---------+---------+----------------------+-------+--------+---------------|
| B       | C       | Receivables          |   100 |    -60 |            20 |
| B       | C       | Receivables          |   200 |    -80 |            20 |
| C       | B       | Payables             |   300 |     20 |            20 |
| C       | B       | Payables             |   100 |     30 |            20 |
| /B/     | /C/     | /Other Expenditures/ |       |   /90/ |          /20/ |

In general, the differential items should be aggregated if all characteristics are same(except Account) before posting to the ACDOCC.

**** Richer Data for Different Cases
Besides the reciprocal transactions between B and C, let's produce more data to cover more cases. The column =Case= is added only to describe which lines belong to the same selection pair, it won't be saved into ACDOCC.
| Case | Company | Partner | Account     | TTYPE | Amount | P.LVL |
|------+---------+---------+-------------+-------+--------+-------|
|    1 | B       | C       | Receivables |   100 |     60 |    05 |
|      | B       | C       | Receivables |   200 |     80 |    05 |
|      | C       | B       | Payables    |   300 |    -20 |    05 |
|      | C       | B       | Payables    |   100 |    -30 |    05 |
|    2 | C       | B       | Receivables |   200 |     10 |    05 |
|      | B       | C       | Payables    |   200 |      0 |    05 |
|    3 | D       | E       | Receivables |   200 |     30 |    05 |
|      | E       | D       | Payables    |   200 |    -30 |    05 |
|    4 | E       | D       | Receivables |   200 |     15 |    05 |
|    5 | B       | D       | Receivables |   200 |     40 |    05 |
|      | D       | B       | Payables    |   200 |    -40 |    05 |
|    6 | A       | B       | Receivables |   200 |     45 |    05 |
|      | B       | A       | Payables    |   200 |    -35 |    05 |
|    7 | A       | X       | Receivables |   200 |     70 |    05 |
|      | X       | A       | Payables    |   200 |    -70 |    05 |

Suppose the differential items is customized in this way:
| Field          | Debit              | Credit        |
|----------------+--------------------+---------------|
| Account        | Other Expenditures | Other Revenue |
| TTYPE          |                    |               |

Let's see what happen case by case:
*Case 1:* Same as above.

*Case 2:* The reverse correlation of case 1, that is B is buyer, C is seller. B has the aggregated payable amount of 0. The lines should be eliminated:
| Case | Company | Partner | Account            | TTYPE | Amount | P.LVL |
|------+---------+---------+--------------------+-------+--------+-------|
|    2 | C       | B       | Receivables        |   200 |     10 |    05 |
|      | C       | B       | Receivables        |   200 |    -10 |    20 |
|      | C       | B       | Other Expenditures |   200 |     10 |    20 |
|      | B       | C       | Payables           |   200 |      0 |    05 |

*Case 3:* Reciprocal transactions between D and E in group Germany. The amounts are same, and can be fully eliminated, no differential line is generated:
| Case | Company | Partner | Account     | TTYPE | Amount | P.LVL |
|------+---------+---------+-------------+-------+--------+-------|
|    3 | D       | E       | Receivables |   200 |     30 |    05 |
|      | D       | E       | Receivables |   200 |    -30 |    20 |
|      | E       | D       | Payables    |   200 |    -30 |    05 |
|      | E       | D       | Payables    |   200 |     30 |    20 |

*Case 4:* Only one side has the line, then no elimination should be given:
| Case | Company | Partner | Account     | TTYPE | Amount | P.LVL |
|------+---------+---------+-------------+-------+--------+-------|
|    4 | E       | D       | Receivables |   100 |     15 |    05 |

*Case 5:* The 2 entities B and D don't share the same parent group, but share the same grandpa group. The transactions between them should be eliminatd:
| Case | Company | Partner | Account     | TTYPE | Amount | P.LVL |
|------+---------+---------+-------------+-------+--------+-------|
|    3 | B       | D       | Receivables |   200 |     40 |    05 |
|      | B       | D       | Receivables |   200 |    -40 |    20 |
|      | D       | B       | Payables    |   200 |    -40 |    05 |
|      | D       | B       | Payables    |   200 |     40 |    20 |

*Case 6:* A is directly under root group Europa, B is under the sub group France. The transactions between them should be eliminatd:
| Case | Company | Partner | Account            | TTYPE | Amount | P.LVL |
|------+---------+---------+--------------------+-------+--------+-------|
|    3 | A       | B       | Receivables        |   200 |     45 |    05 |
|      | A       | B       | Receivables        |   200 |    -45 |    20 |
|      | B       | A       | Payables           |   200 |    -35 |    05 |
|      | B       | A       | Payables           |   200 |     35 |    20 |
|      | A       | B       | Other Expenditures |   200 |     10 |    20 |

*Case 7:* Transactions are between an external entity, then no elimination should be given:
| Case | Company | Partner | Account     | TTYPE | Amount | P.LVL |
|------+---------+---------+-------------+-------+--------+-------|
|    7 | A       | X       | Receivables |   100 |     70 |    05 |
|      | X       | A       | Payables    |   100 |    -70 |    05 |

In any cases, the group information is not posted to the elimination documents. Because during reporting, the group information can be dynamically cast the journal items. You can find detail in the _Group Reporting_ sector. 
**** Thresholds
Say, the following reported financial data is being processed: Receivables and payables along with the differential items have a subitem =Due Date=.

*The threshold is 380*

Reported data:
| Company | Partner | Account     |   Due Date | Amount | P.LVL |
|---------+---------+-------------+------------+--------+-------|
| A       | B       | Receivables | 2016.10.15 |    100 |    05 |
| A       | B       | Receivables | 2016.11.24 |     50 |    05 |
| B       | A       | Payables    | 2016.10.15 |   -500 |    05 | 

Elimination Document:
| Line Item | Company | Partner | Account            |   Due Date | Amount | P.LVL |
|-----------+---------+---------+--------------------+------------+--------+-------|
|         1 | A       | B       | Receivables        | 2016.10.15 |   -100 |    20 |
|         2 | B       | A       | Payables           | 2016.10.15 |    500 |    20 |
|         3 | A       | B       | Other Revenue      | 2016.10.15 |   -400 |    20 |
|         4 | A       | B       | Receivables        | 2016.11.24 |    -50 |    20 |
|         5 | A       | B       | Other Expenditures | 2016.11.24 |     50 |    20 |

Check of the threshold:

*Case 1*: Threshold is checked per differential line item. Line 3 has the difference -400, whose absolute value exceeds 380. The posting is not allowed.

*Case 2*: Threshold is checked per method step. The total difference by adding line 3 and line 5 is -350, whose absolute value doesn't exceed 380. The posting is allowed. 

**** Thresholds with On-The-Fly Display
As On-The-Fly run elimination doesn't do posting anyway, then the display of result should explicitly show which lines are invalid. Let's run a more complicate case.

In the posting strategy, we choose posting to the "the lower value". The key figure is set to "Transaction Currency". Check threshold per different row. Nothing changes for the differential items settings.

In the =Thresholds=, we give following settings:
| Currency | Text          | Amount |
|----------+---------------+--------|
| FRF      | French Franc  |    100 |
| EUR      | European Euro |    150 |

The reported data looks like:
| Company | Partner | Account     | TC_Amount | TC_Key | GC_Amount | GC_Key | P.LVL |
|---------+---------+-------------+-----------+--------+-----------+--------+-------|
| B       | C       | Receivables |  100      | FRF    |       200 | EUR    |    05 |
| C       | B       | Payables    |  -170     | FRF    |      -340 | EUR    |    05 |

Intermediate Elimination Document:
| Company | Partner | Account       | TC_Amount | TC_Key | GC_Amount | GC_Key | P.LVL |
|---------+---------+---------------+-----------+--------+-----------+--------+-------|
| B       | C       | Receivables   |      -100 | FRF    |      -200 | EUR    |    20 |
| C       | B       | Payables      |       170 | FRF    |       340 | EUR    |    20 |
| B       | C       | Other Revenue |       -70 | FRF    |      -170 | EUR    |    20 |

The TC_Amount of the Receivables accounts is lower than Payables accounts, so the difference will be recorded to Company B. The difference of transaction currency is -70, whose absolute value doesn't exceed the threshold 100, so it is valid. However the difference of group currency is -170, which exceeds the threshold 150. 

The On-The-Fly Elimination Report will be display this way:
| Group  | Account       | Company | Partner | P.LVL | TC(FRF) | GC(EUR) |
|--------+---------------+---------+---------+-------+---------+---------|
| France | Receivables   |         |         |       |       0 |       0 |
|        |               | B       | C       |    05 |     100 |     200 |
|        |               | B       | C       |    20 |    -100 |    -200 |
|        | Payables      |         |         |       |       0 |       0 |
|        |               | C       | B       |    05 |    -170 |    -340 |
|        |               | C       | B       |    20 |     170 |     340 |
|        | Other Revenue |         |         |       |     -70 |  ~-170~ |
|        |               | B       | C       |    20 |     -70 |  ~-170~ |
The amount "-170" in Other Revenue will be marked with RED color to indicate invalid eliminations. When user place the cursor on the invalid value, tootips will show to tell why. In this case, the difference exceeds the threshold value.

**** Group Reporting
Based on the group hierarchy, the reported data, and the auto posted elimination documents, we can generate group level reports. Now suppose the reported data and the elimination documents are all in the HANA global temporary table: GT_ACDOCC.

| Company | Partner | Account            | P.LVL | TTYPE | Amount |
|---------+---------+--------------------+-------+-------+--------|
| B       | C       | Receivables        |    05 |   100 |     60 |
| B       | C       | Receivables        |    20 |   100 |    -60 |
| B       | C       | Other Expenditures |    20 |   100 |     60 |
| B       | C       | Receivables        |    05 |   200 |     80 |
| B       | C       | Receivables        |    20 |   200 |    -80 |
| B       | C       | Other Expenditures |    20 |   200 |     80 |
| C       | B       | Payables           |    05 |   300 |    -20 |
| C       | B       | Payables           |    20 |   300 |     20 |
| B       | C       | Other Revenue      |    20 |   300 |    -20 |
| C       | B       | Payables           |    05 |   100 |    -30 |
| C       | B       | Payables           |    20 |   100 |     30 |
| B       | C       | Other Revenue      |    20 |   100 |    -30 |
| C       | B       | Receivables        |    05 |   200 |     10 |
| C       | B       | Receivables        |    20 |   200 |    -10 |
| B       | C       | Payables           |    05 |   200 |      0 |
| D       | E       | Receivables        |    05 |   200 |     30 |
| D       | E       | Receivables        |    20 |   200 |    -30 |
| E       | D       | Payables           |    05 |   200 |    -30 |
| E       | D       | Payables           |    20 |   200 |     30 |
| E       | D       | Receivables        |    05 |   200 |     15 |
| B       | D       | Receivables        |    05 |   200 |     40 |
| B       | D       | Receivables        |    20 |   200 |    -40 |
| D       | B       | Payables           |    05 |   200 |    -40 |
| D       | B       | Payables           |    20 |   200 |     40 |
| A       | B       | Receivables        |    05 |   200 |     45 |
| A       | B       | Receivables        |    20 |   200 |    -45 |
| B       | A       | Payables           |    05 |   200 |    -35 |
| B       | A       | Payables           |    20 |   200 |     35 |
| A       | B       | Other Expenditures |    20 |   200 |     15 |
| A       | X       | Receivables        |    05 |   200 |     70 |
| X       | A       | Payables           |    05 |   200 |    -70 |

The group hierarchy information are stored in 2 table:
1. The Entity master data table (RTC_ENTITY) which has the group attribute:
| Entity | Group   |
|--------+---------|
| A      | Europa  |
| B      | France  |
| C      | France  |
| D      | Germany |
| E      | Germany |

2. The group node (RTC_GNODE) which constructs the hierarchy:
| Group     | PGroup    |
|-----------+-----------|
| Worldwide |           |
| Europa    | Worldwide |
| France    | Europa    |
| Germany   | Europa    |

Now we want to report on group "France". First, we should recursively find all the entities belong to the group. They are B and C. Then the data filtering on the GT_ACDOCC should be:
#+BEGIN_SRC sql
select * from GT_ACDOCC 
 where (COMPANY = 'B' or COMPANY = 'C' and PLVL < 20)
    or (COMPANY = 'B' or COMPANY = 'C' and PARTNER = 'B' or PARTNER = 'C' and PLVL = 20) 
#+END_SRC 

The report look like:
| Group  | Account            | TTYPE | Company | Partner | P.LVL | GC(EUR) |
|--------+--------------------+-------+---------+---------+-------+---------|
| France | Receivables        |       |         |         |       |    *40* |
|        |                    |   100 | B       | C       |    05 |      60 |
|        |                    |   100 | B       | C       |    20 |     -60 |
|        |                    |   200 | B       | C       |    05 |      80 |
|        |                    |   200 | B       | C       |    20 |     -80 |
|        |                    |   200 | C       | B       |    05 |      10 |
|        |                    |   200 | C       | B       |    20 |     -10 |
|        |                    |   200 | B       | D       |    05 |      40 |
|        | Payables           |       |         |         |       |   *-35* |
|        |                    |   300 | C       | B       |    05 |     -20 |
|        |                    |   300 | C       | B       |    20 |      20 |
|        |                    |   100 | C       | B       |    05 |     -30 |
|        |                    |   100 | C       | B       |    20 |      30 |
|        |                    |   200 | B       | C       |    05 |       0 |
|        |                    |   200 | B       | A       |    05 |     -35 |
|        | Other Expenditures |       |         |         |       |   *140* |
|        |                    |   100 | B       | C       |    20 |      60 |
|        |                    |   200 | B       | C       |    20 |      80 |
|        | Other Revenue      |       |         |         |       |   *-50* |
|        |                    |   300 | B       | C       |    20 |     -20 |
|        |                    |   100 | B       | C       |    20 |     -30 |

If I want to report group Europa, then all the data will be involved:
| Group  | Account            | TTYPE | Company | Partner | P.LVL | GC(EUR) |
|--------+--------------------+-------+---------+---------+-------+---------|
| Europa | Receivables        |       |         |         |       |    *85* |
|        |                    |   100 | B       | C       |    05 |      60 |
|        |                    |   100 | B       | C       |    20 |     -60 |
|        |                    |   200 | B       | C       |    05 |      80 |
|        |                    |   200 | B       | C       |    20 |     -80 |
|        |                    |   200 | C       | B       |    05 |      10 |
|        |                    |   200 | C       | B       |    20 |     -10 |
|        |                    |   200 | D       | E       |    05 |      30 |
|        |                    |   200 | D       | E       |    20 |     -30 |
|        |                    |   200 | E       | D       |    05 |      15 |
|        |                    |   200 | B       | D       |    05 |      40 |
|        |                    |   200 | B       | D       |    20 |     -40 |
|        |                    |   200 | A       | B       |    05 |      45 |
|        |                    |   200 | A       | B       |    20 |     -45 |
|        |                    |   200 | A       | X       |    05 |      70 |
|        | Payables           |       |         |         |       |   *-70* |
|        |                    |   300 | C       | B       |    05 |     -20 |
|        |                    |   300 | C       | B       |    20 |      20 |
|        |                    |   100 | C       | B       |    05 |     -30 |
|        |                    |   100 | C       | B       |    20 |      30 |
|        |                    |   200 | B       | C       |    05 |       0 |
|        |                    |   200 | E       | D       |    05 |     -30 |
|        |                    |   200 | E       | D       |    20 |      30 |
|        |                    |   200 | D       | B       |    05 |     -40 |
|        |                    |   200 | D       | B       |    20 |      40 |
|        |                    |   200 | B       | A       |    05 |     -35 |
|        |                    |   200 | B       | A       |    20 |      35 |
|        |                    |   200 | X       | A       |    05 |     -70 |
|        | Other Expenditures |       |         |         |       |   *155* |
|        |                    |   100 | B       | C       |    20 |      60 |
|        |                    |   200 | B       | C       |    20 |      80 |
|        |                    |   200 | A       | B       |    20 |      15 |
|        | Other Revenue      |       |         |         |       |   *-50* |
|        |                    |   300 | B       | C       |    20 |     -20 |
|        |                    |   100 | B       | C       |    20 |     -30 |

*** Elimination Runables 
#+Caption: Elimination Detial Flow
[[../image/EliminationDetailFlow.png]] 

Elimination runables are AMDP methods that are genereted according the definations of an ELIM method. An ELIM method definiation can be shared for reconciliation and elimination. Because both reconciliation and elimination share the same source data reading logic, which are the Selection 1 and Selection 2. The difference between them is that: a reconciliation report only compares the amount between, for example, AP of Company A and AR of Company B; while the elimination will post auto adjustments, check thresholds, finally report the eliminated result or do postings.

The Elimination Run reads the translated result based on the 2 selections and then insert the reversed sign amounts into GT_ACDOCC. For example, it reads AP of company A (Selection 1) and AR of company B(Selection 2), reverse the sign for each line's amounts that selected, and insert them back to GT_ACDOCC. Of cource, every business relationship will be applied with the same logic. 

The eliminated lines should be calculated for differences and record them into differential items. Based on the posting strategy, the system determins on which side(entity) the differences should be posted. Those difference lines will also be inserted into GT_ACDOCC so that from group level, the B/S and I/S are still balanced to zero. 

Threshold values are checked based on the checking strategy and threshold values maintained. If the amount exceeds the value, posting is not allowed. However, group reporting can still be made with alerts that indicate which amounts can not be eliminated automatically.

The posting method will read the temporal data in GT_ACDOCC and transport it to the core posting API. The eliminated result will finally be persisted in ACDOCC.

In order to parallely execution of mulitple elimination steps, each step should be given a dedicate global temporary table. This is because if multiple steps update the same table(GT_ACDOCC), techniquely, parallelism is not allowed. The step temporaray table holds the final result of each step, which then be merged into GT_ACDOCC.

**** Psudeo SQL
#+CAPTION: Elimination SQL Scripts
#+begin_src sql
-- Eliminate all internal reciprocal transactions 
insert into GT_ACDOCC
  select '20' as PLVL,
         (0 - TC) as TC,
         (0 - LC) as LC,
         (0 - GC) as GC,
         (0 - QUANTITY) as QUANTITY,
         * 
    from GT_ACDOCC
   where ACCOUNT in <selection_1> or account in <selection_2>
     and ENTITY in <all_entities_under_the_root_group>
     and PENTITY in <all_entities_under_the_root_group>;

-- Generate Difference Lines, replace the accounts and subitems to the differenctial items.
var LT_ACDOCC =
select (case when GC > 0
              'Other Expenditures'
             when GC < 0
              'Other Revenue'
          end) as ACCOUNT,
       <subitem> as SUBITEM,
       '' as OTHER_CHARACTORISTICS
       (0 - sum(TC)) as TC,
       (0 - sum(LC)) as LC,
       (0 - sum(GC)) as GC,
       (0 - sum(QUANTITY)) as QUANTITY,
       *
  from GT_ACDOCC
 where PLVL = '20';
#+end_src

** Appendix: Existing Elimination Solutions and UIs
*** BPC Inter-company Booking & US Elimination

**** Inter-company Booking
#+Caption: Inter-company Booking
[[../image/Reconciliation_BPC.png]] 

Intercompany booking records the declarations and reported balances by other entities against a particular entity. This allows business users within each reporting entity to run a report that matches all of its declarations and reported balances against the balances of the rest of the entities, without having to assign to each owner read-access for other entities. Bookings that make the Intercompany declarations match can be automatically generated, and details can be posted to the consolidation model.

You use the Intercompany Booking business rule table to define the posting rules the system uses in generating the entries to match the Intercompany balances and declarations.

The values entered in the following properties determine default elimination logic:
| Dimension    | Property  | Content                                                 |
|--------------+-----------+---------------------------------------------------------|
| Account      | ELIMACC   | A valid account in this dimension                       |
| Entity       | ELIM      | Y or blank                                              |
| Intercompany | ENTITY    | The entity ID corresponding to this intercompany member |
| Currency     | REPORTING | Y or blank                                              |

The default elimination logic does the following:
1. Scans all base level, non-elimination entities, which are entities with the property ELIM <> Y.
2. In case the model has a currency dimension, restricts its action to all reporting currencies, which are currencies that have the property REPORTING=Y. Data in local currency cannot be eliminated because it is in different currencies.
3. Eliminates all values of the accounts to be eliminated, which are accounts that have the property ELIMACC<>blank, into the desired plug account, which is the account specified by the ELIMACC property.
4. The elimination is performed in the elimination entity below the first common parent.The common parent is determined as follows:
   + The system identifies the two entities for which a common parent must be found. The first entity is the current entity member. The second entity is the entity corresponding to the current Intercompany member. This entity is obtained by reading the content of the property ENTITY of the current Intercompany member.
   + The system searches in a selected entity hierarchy for the first member that has both entities as descendants. This is the common parent.
   + Then the system searches in the immediate descendants of the common parent for a valid elimination entity (an entity that has the property ELIM=Y). This is the entity in which the system stores the results of the elimination.

The default elimination logic searches in the first hierarchy of the entity dimension. This can be modified to have the elimination performed in all hierarchies existing in the entity dimension. If no common parent is found, no elimination occurs. If no elimination entity is found below the first common parent, the next common parent is searched.

**** US Elimination
#+Caption: US Elimination Header
[[../image/Elimination01_BPC.png]]  

#+Caption: US Elimination Detail
[[../image/Elimination02_BPC.png]]  

When reporting the financial results of a group of entities, you may want to see the results for the group net all Intercompany activity within the group. Therefore, the system identifies Intercompany activities and balances and posts entries so these activities and balances are fully eliminated when looking at the overall results for the group. US eliminations functionality addresses the posting of Intercompany eliminations in scenarios where a full legal consolidation model is not required, such as within a standard financial model. When utilizing a legal consolidation model, Intercompany eliminations are normally handled as part of an eliminations and adjustments function.

Intercompany elimination entries should be reflected only in groups in which both the entity and the partner entity are part of the group. To address this, US eliminations uses a concept known as posting at first common parent.

US eliminations are normally used in financial models as opposed to legal consolidation models.

The US eliminations business rules define the audit members to eliminate. For each of these audit members you then define the corresponding destination audit member under which the system should post the elimination postings.

The values entered in the following properties determine default elimination logic:
| Dimension    | Property  | Content                                                                                         |
|--------------+-----------+-------------------------------------------------------------------------------------------------|
| Account      | ELIMACC   | A valid account against which the actual Intercompany account to be eliminated should be offset |
| Entity       | ELIM      | Y or blank                                                                                      |
| Intercompany | ENTITY    | The entity ID corresponding to this Intercompany member                                         |
| Currency     | REPORTING | Y or blank                                                                                      |

The default elimination logic does the following:
1. Scans all base level non-elimination entities (entities having the property ELIM <> Y).
2. In case the model has a currency dimension, restricts its action to all reporting currencies only (currencies having the property REPORTING=Y). Data in local currency cannot be eliminated because it is in different currencies.
3. Eliminates all values of the accounts to be eliminated (accounts having property ELIMACC<>blank) into the desired plug account (the account specified by the ELIMACC property itself).
4. The elimination is posted to the elimination entity immediately below the first common parent. The common parent is derived as follows:
   + For a particular record the system identifies the two entities for which a common parent must be found. The first entity is the current entity member and the second entity is the entity corresponding to the current Intercompany member. This entity is obtained reading the content of the property ENTITY of the current Intercompany member.
   + The system searches in a selected entity hierarchy for the first member that has both entities as descendants. This is the common parent.
   + Then the system searches in the immediate descendants of the common parent for a valid elimination entity (an entity having the property ELIM=Y). This is the entity where the results of the elimination are stored.
The default elimination logic does its searches in the first organizational structure (hierarchy) of the entity dimension. This can be modified to have the elimination performed in all hierarchies existing in the entity dimension. If no common parent is found, no elimination occurs. If no elimination entity is found below the first common parent, the next common parent is searched.

**** Other Business Rules
#+Caption: Currency Translation 
[[../image/CT_BPC.png]]  

#+Caption: Account-Based Calculation
[[../image/Reclassification_BPC.png]]  

#+Caption: Carry Forward
[[../image/CarryForward_BPC.png]]  

*** SEM-BCS IU Elimination & Reconciliation

#+Caption: Elimination Method General Tab
[[../image/Elimination01_BCS.png]]

#+Caption: Elimination Method Selection Tab
[[../image/Elimination02_BCS.png]]  

#+Caption: Elimination Method Differences Tab
[[../image/Elimination03_BCS.png]] 

#+Caption: Elimination Method Limits Tab
[[../image/Elimination04_BCS.png]] 

*** EC-CS Inter-Unit Elimination

#+Caption: Elimination Method 01
[[../image/Elimination01_ECCS.png]]

#+Caption: Elimination Method 02
[[../image/Elimination02_ECCS.png]]  

#+Caption: Elimination Method 03
[[../image/Elimination03_ECCS.png]] 

#+Caption: Elimination Method 04
[[../image/Elimination04_ECCS.png]] 

#+Caption: Elimination Method 05
[[../image/Elimination05_ECCS.png]] 

#+Caption: Elimination Method 06
[[../image/Elimination06_ECCS.png]] 

*** FC Elimination

#+Caption: Reconciliation Rule Scope Defination 
[[../image/Reconciliation01_FC.png]]

#+Caption: Reconciliation Rule Detial Defination
[[../image/Reconciliation02_FC.png]]  

#+Caption: Elimination Selection Defination
[[../image/Elimination01_FC.png]] 

#+Caption: Elimination Rule Scope Defination
[[../image/Elimination02_FC.png]] 

#+Caption: Elimination Rule Detail Defination
[[../image/Elimination03_FC.png]] 
