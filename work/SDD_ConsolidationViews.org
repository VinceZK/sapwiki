#+PAGEID: 1832374030
#+VERSION: 13
#+STARTUP: align
#+TITLE: SDD-Consolidation Views
#+OPTIONS: toc:1
** General Information
*** Stakeholders and Roles
| Role                  | Name               |
|-----------------------+--------------------|
| Author(s)             | Vincent Zhang      |
| Architect             | Vincent Zhang      |
| Product Owner         | Shi Ying           |
| Information Developer | Ciaran             |
| Quality Responsible   | Yao Cen            |
| Developers            | Steve Mo, Sam, Jin |

*** References
|                |                  |               | <30>                           |
| Document Title | Date             | Link          | Comments                       |
|----------------+------------------+---------------+--------------------------------|
| HANA Script    | <2016-02-21 Sun> | [[http://help.sap.com/saphelp_hanaplatform/helpdata/en/92/11209e54ab48959c83a7ac3b4ef877/content.htm?frameset=/en/60/088457716e46889c78662700737118/frameset.htm&current_toc=/en/ed/4f384562ce4861b48e22a8be3171e5/plain.htm&node_id=3][online help]]   | Online help of HANA SQL scripts. You can find all your want about how to write in HANA SQL scripts. |
| AMDP Guide     | <2016-02-21 Sun> | [[http://help.sap.com/abapdocu_740/en/index.htm?file=abenamdp.htm][ABAP Keywords]] | All about AMDP: Keywords and Syntax. |

** Context
Consolidation views are CDS views and HANA calculation views genereated by the modeling tool for different consolidation purposes. 

Based on the foundation views and other meta definitions (Chart of Account, Fiscal Year Variant, consolidation dimension, and so on), the modeling tool can generate upper views which can be used by different up-level applications. Inspired by SEM-BCS, which genreates BW cubes and provides users the maxium flexibility to define their own consolidation model, RTC generates HANA views instead. The main benifit is *we eliminate the data replication without losing much flexibility*. And we leverage full capabiltiy of HANA's in-memory and column-based  technology. 

The overall diagram of the view stack is given with detial explanations attached:
#+Caption: Consolidation Views Stack Overview
[[../image/ConsViews02.png]]

1. The main data source comes from ACDOCA and ACDOCC. Of course, you can replace ACDOCA to any other tables (like ACDOCP for planning, or even Z_tables) depands on the data you want to run consolidation. But ACDOCC cannot be replaced, as it is the only storage to hold the consolidated journal entries generated during consolidation run.
2. As most consolidations read data from financial journals, we mainly use ACDOCA as the data source. Then a foundation view needs to be created based on ACDOCA so that you can project fields from ACDOCA and apply necessary filterings on the ledger field and company code field. The foundation view is created in HANA Stuido either by CDS or HANA calculation view technology. And this is the only step which needs the horriable HANA Stuido. Further more, we can deliever some sample foundation views for the out-of-box usage.  
3. Then the modeling tool will create the base views on the assigned foundation view. The base views mainly apply 6 logics:
   1. Mapping financial orgnization assignments to consolidation entity;
   2. Mapping operational Chart-of-Accounts to group Chart-of-Accounts;
   3. Mapping operational Fiscal-Year-Variant to group Fiscal-Year-Variant;
   4. Union ACDOCC with correct fields mappings.
   5. If the model is set to be integrated with BPC, then there will be 2 sets of base views gerenated. One is using HANA calculation view, the other is CDS view. The logics of the 2 view sets are exactly the same. This is because BPC cannot consume CDS views, however, S/4HANA needs CDS views. And the CDS views are actually created based on the HANA calculation view using table function (The golden lines indicates the view flow).
   6. If the model is not set to be integrated with BPC, then the foundation view should be CDS view, and the HANA calculation views won't be generated (The blue lines indicates the view flow).
4. The base view is the base for all other consolidation views built upon. Consolidation views can be grouped by differenct usages, like for validation, for reporting, for BPC consolidation, and so on. 
5. Validation views are added to the BRF+ application, which is also generated by the model. They can then be accessed by Validation Engine, which allow you to create various rules based on the CDS views(aka rule vocabulary). Validation views are designed for validation purposes, so the main consideration is to facilit end-users to easily define rules. They may have input parameters(like entity, fiscal period, and so on), so that rules based on it can be run in different data contexts.
6. BPC views are HANA calc views which are only consumed by BPC through a virual info-provider(or composite info-provider). There will be multiple views generated according to 2 considerations: 1)whether the data is in ACDOCA or ACDOCC; 2)whether it needs to be timestamp filtering or not.  Then at least, 4 views are generated: Final data from ACDOCA, preliminary data from ACDOCA, final data from ACDOCC, and preliminary data from ACDOCC. The 4 views are merged into a union calculation view.
7. Currency Translation Method(AMDP) directly accesses the base view to retrieve data. The data is then translated and temporary stored in the Global Temporary Table, which can either be reported to the end-user, or be input for the follow-up consolidation tasks(like elimination).
8. There are also consolidation views for reporting, and master data views on entity and FS items.  
 
*** Data Cut-off
A [[https://wiki.wdf.sap.corp/wiki/x/wY4GbQ][Data Release Request]] is raised by a local accountant as a data cut-off record. It contains information like: model, version(category), entity, fiscal year/period, and cut-off timestamp. The group accountant uses this filter information to pull data from ACDOCA/C for further processing. 

The data release requests(DRR) are stored in table =RTC_DRR=, also having user statuses and system statuses recorded. Only if a DRR is in user status "Released", group accountants can run validation on the data it points; If a DRR is in status "Approved", which means the group accountant accept the data submitted, and ready for consolidation. 

Table =RTC_DRR= is either joined with ACDOCA/C, or be picked out of the correct DRR to filter in data so that only before a certain point of the data participates in consolidation. Besides,  actions and logs, like validation result, translation result, comments & attachments, which are related to a data release activity, are all recorded to a DRR.

*** BPC Integration
For the reason of BPC integration, which means you must pass all your logics in the consoldiation views to the BW interfaces(virtual info-providers), you have to make sure all the OLAP operations should work properly on your views. Bearing in mind, info-providers don't support input parameters, which means you can not pass a timestamp to it. Then the only way you can go is *stacking Views*. 

The BPC consolidation views are generated by the modeling tool. For each BPC category, there will be a set of views generated by considering ACDOCA/C and Final/Preliminary. The term "Final" means data needs to be cut-off by given a timestamp, and "Preliminary" means always getting the most recent data in ACDOCA/C. The Final views have already joined with the =RTC_DRR= to get the lastest submitted/approved data. 

So now, each BPC category has the pair <FINAL/PRELIM>_A and <FINAL/PRELIM>_C. With a model having multiple BPC categories, these views are stacked(union) and form the OLAP cube-like thing. 
    
** Overall Design
*** Key Requirements and Design Goals
BPC can access the real-time data in ACDOCA with timestamp filtering. 

The requirement comes from the legal consolidation which require strict data process control. Only the data that local accountants submitted can group accountants run validation and consolidation on them. But if we let BPC access data on ACDOCA directly, group accountants will always access the most recent data without a handover control. Meanwhile, as the continues changing of the data in ACDOCA, it causes the data inconsistency during a consolidation process. 

The general idea is to use timestamps to cut-off data in ACDOCA. The timestamp usually stands for the time that local accountants close their fiscal periods(soft commit). BPC now only accesses the timestamp-filtered data in ACDOCA. Thus we achieve the data handover without data replications. 

If data is provided through flexible uploading, the handover is then potentially executed when the local accountants upload the data into ACDOCC. So, theriodically, timestamp filtering is not necessary. But it is very often the uploading happens in many times for a single package of data. User may first upload parts of the data, and then the following parts one by one; or the user may change/adjust the uploaded data. For either cases, delta changes should be the best option. Then with the delta change approach, timestamp filtering is also suitable. 

*** 1610 Release(Limited)
The design is divided into 2 versions: =1610 Version=, and the =Completed Version=. As you can imagine, to achieve both real-time data access and sophistic status/workflow control are rather complicate and time/resource consuming. We design a simplified version for 1610, which we eliminate the status control and local validation. Details of the limitations and restrictions are listed:

1. Once the local accountant raise a DRR, it is approved automatically, group accountant can only accept it. There is no embedded control on this process, group accountant must notify the local accountant externally if she doesn't want the data.
2. There is no control on local document posting to the consolidated periods. Those "illegal" postings are discarded, or must be resolved by external controls.
3. Data validation is not integrated, there is no system promise that the submitted data is validate according to the rules. Expensive communication effort are necessary between group accountants and local accountants when such cases happen. 
4. Delta consolidation is not possible. Each time the local accountant raises a new pull request, BPC will always do a full re-consolidation based on the new timestamp. 
5. You cannot defer amounts to the next period.
6. Data inconsistency could happen when consolidation is running or processed with errors, and at the time, there are new DRRs are submitted.

** Detail Design
This section gives the pseduo sql scripts for all the consolidation views.

#+CAPTION: Naming Conventions for the Consolidation Views 
|                           |        |      | <50>                                               |
| Consolidation View        | Group  | Type | Description                                        |
|---------------------------+--------+------+----------------------------------------------------|
| /RTCART/500VINCE1_A       | Base   | CDS  | Consolidation base view: on foundation views only  |
| RTC_C_500VINCE1_A         | Base   | Calc | Consolidation base view: on foundation views only  |
| /RTCART/500VINCE1_C       | Base   | CDS  | Consolidation base view: on ACDOCC only            |
| RTC_C_500VINCE1_C         | Base   | Calc | Consolidation base view: on ACDOCC only            |
| /RTCART/500VINCE1_U       | Base   | CDS  | Consolidation base view: union ACDOCA and ACDOCC   |
| RTC_C_500VINCE1_U         | Base   | Calc | Consolidation base view: union ACDOCA and ACDOCC   |
| RTC_C_500VINCE1_BPCFINALA | BPC    | Calc | Consolidation BPC view: Final on ACDOCA            |
| RTC_C_500VINCE1_BPCFINALC | BPC    | Calc | Consolidation BPC view: Final on ACDOCC            |
| RTC_C_500VINCE1_BPCPRLIMC | BPC    | Calc | Consolidation BPC view: Preliminary on ACDOCC      |
| RTC_C_500VINCE1_BPCPRLIMC | BPC    | Calc | Consolidation BPC view: Preliminary on ACDOCC      |
| RTC_C_500VINCE1_BPCUNION  | BPC    | Calc | Consolidation BPC view: Union View                 |
| /RTCART/500VINCE1_V00     | VALI   | CDS  | Validation view: Current periods+prior periods     |
| /RTCART/500VINCE1_V10     | VALI   | CDS  | Validation view: 16 periods amounts for each currency |
| /RTCART/500VINCE1_V20     | VALI   | CDS  | Validation view: 12 YTD amounts for each currency  |
| /RTCART/500VINCE1_R00     | REPO   | CDS  | Report View: Drill-through to item detail          |
| /RTCART/500VINCE1_ENTITY  | ENTITY | CDS  | Consolidation Entity Master Data View              |
| RTC_C_500VINCE1_ENTITY    | ENTITY | Calc | Consolidation Entity Master Data View              |

*** Consolidation Entity View
The entity view is version independent. Each model genreates one CDS view and one calc view. The underlying table if fixed to =RTC_ENTITY_M=. 

#+Caption: Entity Dimension CDS View /RTCART/500VINCE1_ENTITY
#+BEGIN_SRC sql
create view /RTCART/500VINCE1_ENTITY as 
  select DIM,ENTITY,RCOMP, ...
    from RTC_ENTITY_M
   where MANDT = '820'
     and DIM = '100';
#+END_SRC

#+Caption: Entity Dimension Calculation View RTC_C_500VINCE1_ENTITY
#+BEGIN_SRC sql
create view RTC_C_500VINCE1_ENTITY as 
  select DIM,ENTITY,RCOMP, ...
    from RTC_ENTITY_M
   where MANDT = '820'
     and DIM = '100';
#+END_SRC

The above 2 views only show if the dimension is set on "RCOMP". On other dimensions, fields may be different. Besides, the view should also include all other fields that is not in the INCLUDE structure "RTC_S_ENTITY_BUSINESS_KEY".

*** Data Release Request View
Data Release Request view gives out the latest released/approved requests grouped by each entity each period. This view can be predefined and delivered to customer as standard contents. 
1. CDS View: =P_LRADRR=;
2. HANA Calculation View: =RTC_C_LRADRR=.

*** FS Items View
Financial Statement Item master data dimension view. It is optional assigned in data validation views and report views, so that user can filter data in dimension attributes. 

We can re-use existing CDS views for that purpose, =I_GLAccountInChartOfAccounts= delivered by G/L accounting team should fit our purpose.

For BPC consumption, we can reuse the info-object =/ERP/GLACCT=.

*** FS Items Mapping View
FS Items Mapping View defines all the local accounts and their mappings to the group accounts. A local CoA can be mapped to multiple group CoAs, and vice versa. You can also additionally set filters on the local accounts so that you can control which local accounts should be involved in the consolidation. 

The data source view of stream type "FS Items Mapping" should *at least* contain following fields:
| Field Name | Label                   |
|------------+-------------------------|
| MANDT      | SAP Client              |
| KTOPL      | Local Chart of Accounts |
| SAKNR      | Local Account Number    |
| KKTPL      | Group Chart of Accounts |
| RACCT      | Group Account Number    |

The CDS view =P_CONSACCTM= applies the above protocol, which will be pre-delivered. There is also a HANA calculation view =RTC_C_CONS_ACCT_M= which acts as the counterpart for the BPC consumption. In the BPC integration scenario, stream type "FS Items Mapping" is set to RTC_C_CONS_ACCT_M by default. If you want to change to other views, beside creating a new calculation view, you should also create a CDS view with the same fields and logic. 

Base on the consolidation Chart-of-Accounts you set on the model, it generates FS Items Mapping views. FS Item Mapping view is mainly used to join with FI journal view to filter in the accounts and map to the group accounts. It is not recommended to use FS item Mapping views as the master data dimenstion view.

If you have mapping logic on other fields, for example, "functional area". You should add the field "FUNC_AREA" into the maaping view. Then the field will be used as one of the join condition with the foundation view, which means you should also make sure the function area field exists in the foundation view.
 
#+Caption: FS Item Mapping CDS View
#+BEGIN_SRC sql
  create view /RTCART/500VINCE1_FSIM as 
    select *
      from P_CONSACCTM
     where Client = '500'
       and GroupCoA = 'RTC2';
#+END_SRC    

#+Caption: FS Item Mapping Calculation View
#+BEGIN_SRC sql
  create view RTC_C_500VINCE1_FSIM as 
    select *
      from RTC_C_CONS_ACCT_M
     where Client = '500'
       and GroupCoA = 'RTC2';
#+END_SRC

*** FI Journal Foundation View
This is an example of streamlined foundation view for company consolidation. It projects fields from ACDOCA, however, company code (RBUKRS) is replaced by RCOMP through join with table T001. Only 2 key figures are chosen: TSL and HSL.
| Field Name | Label                               | Usage                                    |
|------------+-------------------------------------+------------------------------------------|
| RCLNT      | SAP Client                          |                                          |
| RLDNR      | Ledger in General Ledger Accounting | For Drill-through                        |
| GJAHR      | Local Fiscal Year                   | For Drill-through                        |
| RBUKRS     | Company Code                        | For Drill-through                        |
| BELNR      | Accounting Document Number          | For Drill-through                        |
| RCOMP      | Company                             |                                          |
| RASSC      | Trading Partner                     |                                          |
| BUDAT      | Posting Date                        | For FYV alignment                        |
| KTOPL      | Local Chart of Accounts             |                                          |
| RACCT      | Local Account Number                |                                          |
| RMVCT      | Transaction Type                    |                                          |
| RTCUR      | Transaction Currency Key            |                                          |
| RHCUR      | Company Code Currency Key           |                                          |
| TSL        | Amount in Transaction Currency      |                                          |
| HSL        | Amount in Company Code Currency     | Mandatory Amount, represent local amount |
| TIMESTAMP  | Timestamp                           | For Data Cut-off                         |

Through foundation view, you see the FI data still in local point of view. The above foundation view will then be converted to consolidation base view, which maps to the group chart of accounts and aligned with the group fiscal year variant. 

Following 2 foundation views are delivered as samples:
| Type | View             | Description                             |
|------+------------------+-----------------------------------------|
| CDS  | P_FOUNDATIONA    | Consolidation Foundation View of ACDOCA |
| Calc | RTC_C_FOUNDATION | Consolidation Foundation View of ACDOCA |

*** Consolidation Base View
Consolidation base views are the basis for other consolidation views to be built on. It contains the common logic that all other consolidation views needed(except dirll-through reports). In the BPC integration scenario, there are also HANA calculation views act as the base views. 
| Field Name  | Label                           |
|-------------+---------------------------------|
| RCLNT       | SAP Client                      |
| MODEL       | Consolidation Model             |
| RTC_CATG    | Data Category                   |
| ACCTP       | Accounting Principle            |
| RVERS       | Variant                         |
| PLEVEL      | Posting Level                   |
| ENTITY      | Consolidation Entity            |
| PENTITY     | Partner Entity                  |
| PERIV       | Group Fiscal Year Variant       |
| RYEAR       | Group Fiscal Year               |
| POPER       | Group Fiscal Period             |
| FISCYEARPER | Group Fiscal Year and Period    |
| KTOPL       | Group Chart of Accounts         |
| RACCT       | Group Account Number            |
| RMVCT       | Transaction Type                |
| RTCUR       | Transaction Currency Key        |
| RHCUR       | Company Code Currency Key       |
| TSL         | Amount in Transaction Currency  |
| HSL         | Amount in Company Code Currency |
| TIMESTAMP   | Timestamp                       |

1. ENTITY is added by joining  =/RTCART/500VINCE1_ENTITY= on field RCOMP, and RCOMP is removed;
2. PENTITY is added by joining  =/RTCART/500VINCE1_ENTITY= on field RASSC, and RASSC is removed;
3. BUDAT is replaced by joining FINS_FISC_DATE for the fields: PERIV, RYEAR, POPER, and FISCYEARPER.
4. KTOPL and RACCT are replaced by joining =/RTCART/500VINCE1_FSIM= for the fields KKTPL and RACCT.

Now, through the consolidation base view, you see the FI journal data in the group view. 

There are 6 consolidation base views generated if the model is also used by BPC. However, theroically, the number of based views is 3: 
1. Base view on ACDOCC;
2. Base view on foundation view(ACDOCA);
3. Base view which union 1 and 2.

I give all the pseduo sql of the 6 base views:

**** Calculation View on ACDOCA only
In case there are more than one data categories in the model, this view should union all the categories. For example, model "VINCE1" has 2 data categories, one is "ACTUAL" with source data from ACDOCA, the other is "PLAN" with source data from ACDOCP. Then the base view should union of the 2 data sources. 
#+BEGIN_SRC sql
create view RTC_C_500VINCE1_A 
as select A.RCLNT,
          'VINCE1'  as MODEL,
          'ACTUAL'  as RTC_CATG,
          ''        as ACCTP,
          ''        as RVERS,
          '01'      as PLEVEL,
          B.ENTITY,
          C.ENTITY as PENTITY,
          D.FISCAL_YEAR_VARIANT as PERIV,
          D.FISCAL_YEAR as RYEAR,
          D.FISCAL_PERIOD as POPER,
          D.FISCYEARPER,
          E.KKTPL as KTOPL,
          E.RACCT,         
          case A.RMVCT when '' then 'F15' else A.RMVCT end as RMVCT,
          A.RTCUR,
          A.RHCUR,
          A.RHCUR as CONS_CUR,
          sum(A.TSL) as TSL,
          sum(A.HSL) as HSL,
          sum(A.HSL) as CONS_SL,
          A.TIMESTAMP
     from RTC_C_FOUNDATION as A
     join RTC_C_500VINCE1_ENTITY as B
       on A.RCOMP = B.RCOMP
left join RTC_C_500VINCE1_ENTITY as C
       on A.RASSC = B.RCOMP
     join RTC_C_FINS_FISC_DATE as D
       on A.RCLNT = D.MANDT
      and A.BUDAT = D.CALENDAR_DATE
     join RTC_C_500VINCE1_FSIM as E
       on A.RCLNT = E.MANDT
      and A.KTOPL = E.KTOPL
      and A.RACCT = E.SAKNR
    where A.RCLNT = '500'
 group by *
union all
   select A.RCLNT,
          'VINCE1'  as MODEL,
          'PLAN'    as RTC_CATG,
          ''        as ACCTP,
          ''        as RVERS,
          '01'      as PLEVEL,
          ...
          sum(A.TSL) as TSL,
          sum(A.HSL) as HSL,
          sum(A.HSL) as CONS_SL,
          A.TIMESTAMP
     from RTC_C_FOUNDATIONP as A 
    where A.RCLNT = '500'
 group by *   
#+END_SRC

**** CDS View on ACDOCA only
You must first create a table function on the calculation view, then create the CDS view on the table function. 
#+BEGIN_SRC sql
  create table function /RTCART/500VINCE1_ATF as 
     select * from  RTC_C_500VINCE1_A;  

  create view /RTCART/500VINCE1_A as 
    select * from /RTCART/500VINCE1_ATF;        
#+END_SRC

**** Calculation View and CDS View on ACDOCC only
The calculation view and CDS view are similar.
#+BEGIN_SRC sql
create view /RTCART/500VINCE1_C 
as select A.RCLNT,
          A.MODEL,
          A.RTC_CATG,
          A.RLDNR,
          A.RVERS,
          A.PLEVEL,
          C.ENTITY as ENTITY,
          case D.ENTITY when '' then 'NONE' else D.ENTITY end as PENTITY,
          A.PERIV,
          A.RYEAR,
          A.POPER,
          A.FISCYEARPER,
          A.KTOPL,
          A.RACCT,         
          A.RMVCT,
          A.RTCUR,
          A.RHCUR,
          A.CONS_CUR,
          sum(A.TSL),
          sum(A.HSL),
          sum(A.CONS_SL),
          A.TIMESTAMP
     from ACDOCC as A
     join RTC_C_500VINCE1_ENTITY as C
       on A.RCOMP = C.RCOMP
left join RTC_C_500VINCE1_ENTITY as D
       on A.RASSC = D.RCOMP
    where A.DELFLG = ''
      and A.MODEL = 'VINCE1'
 group by *;          
#+END_SRC

**** Calculation View and CDS View on union of ACDOCA and ACDOCC
The calculation view and CDS view are similar.
#+BEGIN_SRC sql
  create view /RTCART/500VINCE1_U as 
   select * from  /RTCART/500VINCE1_A
    union all
   select * from  /RTCART/500VINCE1_C;        
#+END_SRC

*** Consolidation Views for BPC
HANA calculation views are generated for the consumption from BPC. Each BPC category has 2 views: one if for the data in ACDOCA and the other is for the data in ACDOCC. There is also a union view which merges all the calculations views of all the BPC categories. If a new BPC category is added, 2 new views will be merged into the union view. The union view is then assigned to a BW virtual provider, on which there is alos a write-back class to allow BPC write data back to ACDOCC. User can also choose to use a composite provider to union data in other cubes, but this is optional. 

The simplified diagram looks like this:
#+Caption: HANA Views for BPC
[[../image/ConsViews06.png]]

Generally, there is 2 types of BPC category: one needs the data cut-off, the other is not. We usually use "FINAL" as the category which needs data cut-off, and "Preliminary" as the category which needs not.

**** Final View A
This view gives out the submitted report data for these S/4 integrated entities. 
#+BEGIN_SRC sql
create view RTC_C_500VINCE1_BPCFINALA as 
  select A.RCLNT,
         A.MODEL,
         'FINAL'   as BPC_CATG,
         'G_NONE'  as RCONGR1,
         A.ENTITY,
         A.PENTITY,
         A.PERIV,
         A.FISCYEARPER,
         A.KTOPL,
         A.RACCT,         
         A.RMVCT,
         'INPUT'   as AUDIT_TRA,
         'LC'      as CONS_CUR,
         SUM(A.CONS_SL) as CONS_SL
    from RTC_C_500VINCE1_A as A
    join RTC_C_LRADRR as B
      on A.RCLNT = B.MANDT
     and A.RYEAR = B.FYEAR
     and A.POPER = B.FPERI
     and A.ENTITY = B.ENTITY
     and A.TIMESTAMP <= B.RTIME
   where B.MODEL = 'VINCE1'
     and B.BPC_CATG = 'FINAL'
group by *;
#+END_SRC

**** Final View C
For those external companies who supplies data through flexible upload, the data is first stored in a staging area (PLEVEL = 00), then the local accountant commits the data which copies the changed data from staging area to the formal area (PLEVEL = 01). Each commit appends delta amounts to the formal area with a timestamp. So now it is the same logic as the data in ACDOCA, we need to join the latest approved request.

The column "AUDIT_TRA" and "RCONGR1" should be fixed with values when doing Flexible upload and S4 CT.
#+BEGIN_SRC sql
  select A.RCLNT,
         A.MODEL,
         'FINAL'   as BPC_CATG,
         A.RCONGR1,
         C.ENTITY,
         C.PENTITY,
         A.PERIV,
         A.FISCYEARPER,
         A.KTOPL,
         A.RACCT,         
         A.RMVCT,
         A.AUDIT_TRA, 
         A.CONS_CUR,
         sum(A.CONS_SL) as CONS_SL
         from RTC_C_500VINCE1_C as A
    left join RTC_ACCTP as B
           on A.RLDNR = B.LEDGER
         join RTC_C_LRADRR as C
           on A.RCLNT = C.MANDT
          and A.RYEAR = C.FYEAR
          and A.POPER = C.FPERI
          and A.ENTITY = C.ENTITY
          and A.TIMESTAMP <= C.RTIME
        where  A.DCATE   = 'Actual'
          and (B.ACCTP = '' or  B.ACCTP   = 'GAAP')
          and (A.RVERS = '' or A.RVERS = '100')
          and A.PLEVEL >= '01'--Posting Level >= 01 means from the reported data and afterwards
     group by *;  
#+END_SRC

**** Preliminary View A
The view gives out the up-to-time report data for S/4 integrated entities.
#+BEGIN_SRC sql
  select A.RCLNT,
         A.MODEL,
         'PRELIM'   as BPC_CATG,
         'G_NONE'  as RCONGR1,
         A.ENTITY,
         A.PENTITY,
         A.PERIV,
         A.FISCYEARPER,
         A.KTOPL,
         A.RACCT,         
         A.RMVCT,
         'INPUT'   as AUDIT_TARA,
         'LC'      as CONS_CUR,
         sum(A.CONS_SL) as CONS_SL
    from RTC_C_500VINCE1_A
group by *;
#+END_SRC

**** Preliminary View C
#+BEGIN_SRC sql
select A.RCLNT,
       A.MODEL,
       'PRELIM'  as BPC_CATG,
       A.RCONGR1,
       A.ENTITY,
       A.PENTITY,
       A.PERIV,
       A.FISCYEARPER,
       A.KTOPL,
       A.RACCT,         
       A.RMVCT,
       A.AUDIT_TRA,
       A.CONS_CUR,
       sum(A.CONS_SL) as CONS_SL
     from RTC_C_500VINCE1_C as A
left join RTC_ACCTP as B
       on A.LEDGER = B.LEDGER
    where A.DCATE   = 'Actual'
      and (B.ACCTP = '' or  B.ACCTP   = 'GAAP')
      and (A.RVERS = '' or A.RVERS = '200')
      and A.PLEVEL >= '01'
 group by *;  
#+END_SRC

**** Union View
The union view merges all the views above with "Union all" operator. Which is then assigned to a BW virtual info-provider. BPC can now access the data just like a standard OLAP cube.

*** Validation View
Validation Views are all CDS, which can be used by validation engine or others. Currently, the validation view is on entity base, which means it can only give data per entity. The bellow view "V00" is designed as a generaic view for that purpose, to support data validation and reporting by entity. It gives out the current period data before a given timestamp, along with prior periods data by filtering in each the approved timestamp.  

#+BEGIN_SRC sql
create view /RTCART/500VINCE1_V00
  with parameters p_rtc_catg:rtc_catg,
                  p_rldnr:rtc_rldnr,
                  p_rvers:rtc_rvers,
                  p_entity:rtc_entity,
                  p_ryear:ryear,
                  p_poper:poper,
                  p_timestamp:timestamp
as select * from  /RTCART/500VINCE1_U
    where rtc_catg  = :p_rtc_catg
      and (rldnr    = :p_rldnr or rldnr = '')
      and (rvers    = :p_rvers or rvers = '')
      and entity    = :p_entity
      and ryear     = :p_ryear
      and poper     = :p_poper
      and timestamp <= :p_timestamp
union all
   select * from /RTCART/500VINCE1_U as a
     join P_LRADRR as b
       on a.rclnt = b.mandt
      and a.model = b.model
      and a.ryear = b.fyear
      and a.poper = b.fperi
      and a.entity = b.entity
    where b.mandt = '500'
      and b.model = 'VINCE1'
      and b.rtc_catg  = :p_rtc_catg
      and b.rldnr     = :p_rldnr
      and b.rvers     = :p_rvers
      and a.rtc_catg  = :p_rtc_catg
      and (a.rldnr    = :p_rldnr or a.rldnr = '')
      and (a.rvers    = :p_rvers or a.rvers = '')
      and a.entity    = :p_entity
      and b.entity    = :p_entity
      and a.ryear     = :p_ryear
      and b.fyear     = :p_ryear
      and a.poper     < :p_poper
      and b.fperi     < :p_poper
      and a.timestamp <= b.rtime     
#+END_SRC

V10 is build upon V00 by spreading the amounts in a row with 17 periods(000~016)
#+BEGIN_SRC sql
create view /RTCART/500VINCE1_V10
  with parameters p_rtc_catg:rtc_catg,
                  p_rldnr:rtc_rldnr,
                  p_rvers:rtc_rvers,
                  p_entity:rtc_entity,
                  p_ryear:ryear,
                  p_poper:poper,
                  p_timestamp:timestamp
as select from  /RTCART/500VINCE1_V00(
                  p_rtc_catg:$parameters.p_rtc_catg,
                  p_rldnr:$parameters.p_rldnr,
                  p_rvers:$parameters.prvers,
                  p_entity:$parameters.p_entity,
                  p_ryear:$parameters.p_ryear,
                  p_poper:$parameters.p_poper,
                  p_timestamp:$parameters.p_timestamp)
{ 
  --First include all characteristic fields except poper
  
  --Then for each amount field, calculate its 16 periods' amounts
  @Semantics.amount.currencyCode: 'RWCUR' 
  sum(case poper 
        when '000' then 
          cast(wsl as abap.dec( 23, 2 )) 
        else 
          cast(0 as abap.dec( 23, 2 )) 
      end) as wslvt,

  @Semantics.amount.currencyCode: 'RWCUR' 
  sum(case poper 
        when '001' then 
          cast(wsl as abap.dec( 23, 2 )) 
        else 
          cast(0 as abap.dec( 23, 2 )) 
      end) as wsl01,
   ...
}group by <all characteristic fields>
#+END_SRC

V20 is build upon V10 by caculate the YTD amounts of prior 12 periods.
#+BEGIN_SRC sql
create view /RTCART/500VINCE1_V20
  with parameters p_rtc_catg:rtc_catg,
                  p_rldnr:rtc_rldnr,
                  p_rvers:rtc_rvers,
                  p_entity:rtc_entity,
                  p_ryear:ryear,
                  p_poper:poper,
                  p_timestamp:timestamp
as select from  /RTCART/500VINCE1_V00(
                  p_rtc_catg:$parameters.p_rtc_catg,
                  p_rldnr:$parameters.p_rldnr,
                  p_rvers:$parameters.prvers,
                  p_entity:$parameters.p_entity,
                  p_ryear:$parameters.p_ryear,
                  p_poper:$parameters.p_poper,
                  p_timestamp:$parameters.p_timestamp)
{ 
  --First include all characteristic fields
  
  --Then for each amount field, calculate its 12 YTD amounts
   case $parameters.p_poper
     when '000' then wslvt
     when '001' then wslvt
     when '002' then wslvt
     when '003' then wslvt
     when '004' then wslvt
     when '005' then wslvt
     when '006' then wslvt
     when '007' then wslvt
     when '008' then wslvt
     when '009' then wslvt
     when '010' then wslvt
     when '011' then wslvt
     when '012' then wslvt
     else (wslvt+wsl01)
   end as wsl_ytd_pre12,
  ...
   case $parameters.p_poper
     when '000' then wslvt
     when '001' then (wslvt+wsl01)
     when '002' then (wslvt+wsl01+wsl02)
     when '003' then (wslvt+wsl01+wsl02+wsl03)
     when '004' then (wslvt+wsl01+wsl02+wsl03+wsl04)
     when '005' then (wslvt+wsl01+wsl02+wsl03+wsl04+wsl05)
     when '006' then (wslvt+wsl01+wsl02+wsl03+wsl04+wsl05+wsl06)
     when '007' then (wslvt+wsl01+wsl02+wsl03+wsl04+wsl05+wsl06+wsl07)
     when '008' then (wslvt+wsl01+wsl02+wsl03+wsl04+wsl05+wsl06+wsl07+wsl08)
     when '009' then (wslvt+wsl01+wsl02+wsl03+wsl04+wsl05+wsl06+wsl07+wsl08+wsl09)
     when '010' then (wslvt+wsl01+wsl02+wsl03+wsl04+wsl05+wsl06+wsl07+wsl08+wsl09+wsl10)
     when '011' then (wslvt+wsl01+wsl02+wsl03+wsl04+wsl05+wsl06+wsl07+wsl08+wsl09+wsl10+wsl11)
     when '012' then (wslvt+wsl01+wsl02+wsl03+wsl04+wsl05+wsl06+wsl07+wsl08+wsl09+wsl10+wsl11+wsl12)
     else (wslvt+wsl01+wsl02+wsl03+wsl04+wsl05+wsl06+wsl07+wsl08+wsl09+wsl10+wsl11+wsl12)
  end as wsl_ytd,  
  case $parameters.p_poper
     when '000' then wslvt
     when '001' then wsl01
     when '002' then wsl02
     when '003' then wsl03
     when '004' then wsl04
     when '005' then wsl05
     when '006' then wsl06
     when '007' then wsl07
     when '008' then wsl08
     when '009' then wsl09
     when '010' then wsl10
     when '011' then wsl11
     when '012' then wsl12
     else wsl12   --TO-DO: period 13~16 are ignored only for simplicity
  end as wsl,     
--End of 12 periods WSL YTD amounts along with current period amount
}
#+END_SRC

*** Report View
The drill-through report needs a view which contains additional columns to breakdown or navigate to the detial line items. The drill-through report view named "R00" has the similar logic with consolidation base view, but with addtional columns:
| Field Name  | Label                               |
|-------------+-------------------------------------|
| RCLNT       | SAP Client                          |
| MODEL       | Consolidation Model                 |
| RTC_CATG    | Data Category                       |
| ACCTP       | Accounting Principle                |
| RVERS       | Variant                             |
| PLEVEL      | Posting Level                       |
| SRC         | Data source tag for Drill-through   |
| ENTITY      | Consolidation Entity                |
| PENTITY     | Partner Entity                      |
| PERIV       | Group Fiscal Year Variant           |
| RYEAR       | Group Fiscal Year                   |
| POPER       | Group Fiscal Period                 |
| FISCYEARPER | Group Fiscal Year and Period        |
| KTOPL       | Group Chart of Accounts             |
| RACCT       | Group Account Number                |
| RMVCT       | Transaction Type                    |
| RTCUR       | Transaction Currency Key            |
| RHCUR       | Company Code Currency Key           |
| TSL         | Amount in Transaction Currency      |
| HSL         | Amount in Company Code Currency     |
| TIMESTAMP   | Timestamp                           |
| RLDNR       | Ledger in General Ledger Accounting |
| RBUKRS      | Company Code                        |
| GJAHR       | Local Fiscal Year                   |
| BELNR       | Accounting Document Number          |
| RCOMP       | Company                             |
| RASSC       | Trading Partner                     |
| LKTOPL      | Local Chart of Accounts             |
| LRACCT      | Local Account Number                |

1. ENTITY is added by joining  =/RTCART/500VINCE1_ENTITY= on field RCOMP.
2. PENTITY is added by joining  =/RTCART/500VINCE1_ENTITY= on field RASSC.
3. BUDAT is replaced by joining FINS_FISC_DATE for the fields: PERIV, RYEAR, POPER, and FISCYEARPER.
4. LKTOPL and LRACCT are renamed from KTOPL and RACCT. 
5. New KTOPL and RACCT are added by joining =/RTCART/500VINCE1_FSIM= for the fields KKTPL and RACCT.

Now, through the consolidation base view, you see the FI journal data in both the local view and group view. The drill-through view at least merges data from 2 sources: one is the foundation view, the other is the ACDOCC. There could be multiple data categories assigned, so the foundation views could be more than one. Following pseduo SQL is given:

#+BEGIN_SRC sql
create view /RTCART/500VINCE1_R00 
as select A.RCLNT,
          'VINCE1'  as MODEL,
          'ACTUAL'  as RTC_CATG,
          ''        as ACCTP,
          ''        as RVERS,
          '01'      as PLEVEL,
          'ACDOCA'  as SRC,
          B.ENTITY,
          C.ENTITY as PENTITY,
          D.FISCAL_YEAR_VARIANT as PERIV,
          D.FISCAL_YEAR as RYEAR,
          D.FISCAL_PERIOD as POPER,
          D.FISCYEARPER,
          E.KKTPL as KTOPL,
          E.RACCT,         
          case A.RMVCT when '' then 'F15' else A.RMVCT end as RMVCT,
          A.RTCUR,
          A.RHCUR,
          A.RHCUR as CONS_CUR,
          A.TSL,
          A.HSL,
          A.HSL as CONS_SL,
          A.TIMESTAMP,
          A.RLDNR
          A.GJAHR,
          A.RBUKRS,
          A.BELNR,
          A.DOCLN,
          A.RCOMP,
          A.RASSC,
          A.LKTOPL,
          A.LRACCT
     from RTC_C_FOUNDATION as A
     join RTC_C_500VINCE1_ENTITY as B
       on A.RCOMP = B.RCOMP
left join RTC_C_500VINCE1_ENTITY as C
       on A.RASSC = B.RCOMP
     join RTC_C_FINS_FISC_DATE as D
       on A.RCLNT = D.MANDT
      and A.BUDAT = D.CALENDAR_DATE
     join RTC_C_500VINCE1_FSIM as E
       on A.RCLNT = E.MANDT
      and A.KTOPL = E.KTOPL
      and A.RACCT = E.SAKNR
    where A.RCLNT = '500'
union all
   select A.RCLNT,
          A.MODEL,
          A.RTC_CATG,
          A.ACCTP,
          A.RVERS,
          A.PLEVEL,
          'ACDOCC'  as SRC,
          B.ENTITY,
          C.ENTITY as PENTITY,
          D.FISCAL_YEAR_VARIANT as PERIV,
          D.FISCAL_YEAR as RYEAR,
          D.FISCAL_PERIOD as POPER,
          D.FISCYEARPER,
          E.KKTPL as KTOPL,
          E.RACCT as RACCT,         
          A.RMVCT,
          A.RTCUR,
          A.RHCUR,
          A.CONS_CUR,
          A.TSL,
          A.HSL,
          A.HSL as CONS_SL,
          A.TIMESTAMP,
          A.RLDNR,
          A.RYEAR as GJAHR,
          A.RBUKRS,
          A.BELNR,
          A.DOCLN,
          A.RCOMP,
          A.RASSC,
          A.KTOPL as LKTOPL,
          A.RACCT as LRACCT
     from ACDOCC as A
     join RTC_C_500VINCE1_ENTITY as B
       on A.RCOMP = B.RCOMP
left join RTC_C_500VINCE1_ENTITY as C
       on A.RASSC = B.RCOMP
     join RTC_C_FINS_FISC_DATE as D
       on A.RCLNT = D.MANDT
      and A.BUDAT = D.CALENDAR_DATE
     join RTC_C_500VINCE1_FSIM as E
       on A.RCLNT = E.MANDT
      and A.KTOPL = E.KTOPL
      and A.RACCT = E.SAKNR
    where A.RCLNT = '500'  
      and A.PLEVEL = '' --Only flexible uploaded/roll-up data. 
union all
   select A.RCLNT,
          'VINCE1'  as MODEL,
          'PLAN'    as RTC_CATG,
          ''        as ACCTP,
          ''        as RVERS,
          '01'      as PLEVEL,
          'ACDOCP'  as SRC,
          ...
          A.TIMESTAMP,
          A.RLDNR,
          A.RYEAR as GJAHR,
          A.RBUKRS,
          A.BELNR,
          A.DOCLN,
          A.RCOMP,
          A.RASSC,
          A.KTOPL as LKTOPL,
          A.RACCT as LRACCT
     from RTC_C_FOUNDATIONP as A
#+END_SRC

The report structure is fixed as the ACDOCC + [LKTOPL, LRACCT, ACCTP]. Incase Integration with BPC, the above view is first utilized using calculation view, then convert to CDS using table function. 
